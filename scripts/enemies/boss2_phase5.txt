
# =============================================================================
# FINAL PHASE - Made in Heaven (5 super skills) - Boss 2 Love/Heart Theme
# =============================================================================

func _boss2_eternal_love() -> void:
	# Super: Heart shape (SPLIT) -> dense rain at player -> HOMING barrage
	if not bullet_scene or not get_parent():
		return
	var player = get_tree().get_first_node_in_group("player")
	if not player:
		return

	# Phase 1: HUGE heart-shaped pattern using parametric heart equation, all SPLIT
	for i in range(40):
		var t = (float(i) / 40.0) * TAU
		var hx = 8.0 * (16.0 * pow(sin(t), 3))
		var hy = -8.0 * (13.0 * cos(t) - 5.0 * cos(2.0 * t) - 2.0 * cos(3.0 * t) - cos(4.0 * t))
		var heart_offset = Vector2(hx, hy)
		var spawn_pos = global_position + heart_offset / 16.0
		var outward = heart_offset.normalized()
		if outward.length() < 0.01:
			outward = Vector2.UP
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = spawn_pos
		bullet.direction = outward
		bullet.speed = 120.0
		bullet.bullet_type = EnemyBullet.BulletType.SPLIT
		bullet.set_sprite("res://assets/sprites/bossbullut-1.png")
		get_parent().add_child(bullet)
		if i % 5 == 4:
			await get_tree().create_timer(0.04).timeout

	await get_tree().create_timer(0.08).timeout

	# Phase 2: Dense rain from top aimed at player (30 bullets)
	var vp = get_viewport_rect().size
	for i in range(30):
		var x_pos = randf_range(60.0, vp.x - 60.0)
		var rain_origin = Vector2(x_pos, 20.0)
		var to_player = rain_origin.direction_to(player.global_position)
		var drift = Vector2(randf_range(-0.12, 0.12), 0)
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = rain_origin
		bullet.direction = (to_player + drift).normalized()
		bullet.speed = randf_range(220.0, 320.0)
		bullet.set_sprite("res://assets/sprites/bossbullut-6.png")
		get_parent().add_child(bullet)
		if i % 6 == 5:
			await get_tree().create_timer(0.02).timeout

	await get_tree().create_timer(0.08).timeout

	# Phase 3: 16 HOMING bullets from boss converging on player
	var aim_angle = global_position.direction_to(player.global_position).angle()
	for i in range(16):
		var spread = aim_angle + (i - 7.5) * 0.25
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = global_position
		bullet.direction = Vector2(cos(spread), sin(spread))
		bullet.speed = 200.0
		bullet.bullet_type = EnemyBullet.BulletType.HOMING
		bullet._homing_strength = 2.0
		bullet._homing_duration = 0.6
		bullet.set_sprite("res://assets/sprites/bossbullut-1.png")
		get_parent().add_child(bullet)
		if i % 4 == 3:
			await get_tree().create_timer(0.02).timeout


func _boss2_heaven_ascension() -> void:
	# Super: Dense quad spiral + BOUNCE ricochets + LASER beams = maximum chaos
	if not bullet_scene or not get_parent():
		return
	var player = get_tree().get_first_node_in_group("player")
	if not player:
		return

	# Dense quad spiral: 4 arms, 80 steps, with BOUNCE and LASER overlays
	for step in range(80):
		# 4 spiral arms rotating outward
		for arm in range(4):
			var base_angle = step * 0.10 + arm * (TAU / 4.0)
			var bullet = bullet_scene.instantiate() as EnemyBullet
			bullet.global_position = global_position
			bullet.direction = Vector2(cos(base_angle), sin(base_angle))
			bullet.speed = 140.0 + step * 0.6
			bullet.bullet_type = EnemyBullet.BulletType.SPIRAL
			bullet.set_sprite("res://assets/sprites/bossbullut-6.png")
			get_parent().add_child(bullet)

		# Every 8 steps: 6 BOUNCE bullets aimed at player that ricochet everywhere
		if step % 8 == 0:
			var bounce_aim = global_position.direction_to(player.global_position).angle()
			for b in range(6):
				var spread = bounce_aim + (b - 2.5) * 0.18
				var bounce = bullet_scene.instantiate() as EnemyBullet
				bounce.global_position = global_position
				bounce.direction = Vector2(cos(spread), sin(spread))
				bounce.speed = 280.0
				bounce.bullet_type = EnemyBullet.BulletType.BOUNCE
				bounce.set_sprite("res://assets/sprites/bossbullut-10.png")
				get_parent().add_child(bounce)

		# Every 12 steps: 2 LASER beams aimed at player
		if step % 12 == 0:
			var laser_aim = global_position.direction_to(player.global_position).angle()
			for l in range(2):
				var offset = (l - 0.5) * 0.12
				var laser = bullet_scene.instantiate() as EnemyBullet
				laser.global_position = global_position
				laser.direction = Vector2(cos(laser_aim + offset), sin(laser_aim + offset))
				laser.speed = 360.0
				laser.bullet_type = EnemyBullet.BulletType.LASER
				laser.set_sprite("res://assets/sprites/bossbullut-7.png")
				get_parent().add_child(laser)

		await get_tree().create_timer(0.03).timeout


func _boss2_heartbreak_apocalypse() -> void:
	# Super: Dense rain -> DECELERATE ring trap -> HOMING edges -> LASER spiral -> orbit cage
	if not bullet_scene or not get_parent():
		return
	var player = get_tree().get_first_node_in_group("player")
	if not player:
		return
	var vp = get_viewport_rect().size

	# Phase 1: Dense rain from top - 36 bullets falling toward player
	for i in range(36):
		var x_pos = randf_range(40.0, vp.x - 40.0)
		var rain_origin = Vector2(x_pos, 10.0)
		var to_player = rain_origin.direction_to(player.global_position)
		var drift = Vector2(randf_range(-0.08, 0.08), 0)
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = rain_origin
		bullet.direction = (to_player + drift).normalized()
		bullet.speed = randf_range(260.0, 360.0)
		bullet.set_sprite("res://assets/sprites/bossbullut-6.png")
		get_parent().add_child(bullet)
		if i % 6 == 5:
			await get_tree().create_timer(0.02).timeout

	await get_tree().create_timer(0.08).timeout

	# Phase 2: DECELERATE ring trap - 28 bullets closing ring around player
	var trap_center = player.global_position
	for i in range(28):
		var angle = (TAU / 28.0) * i
		var spawn_pos = trap_center + Vector2(cos(angle), sin(angle)) * 240.0
		var inward = spawn_pos.direction_to(trap_center)
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = spawn_pos
		bullet.direction = inward
		bullet.speed = 220.0
		bullet.bullet_type = EnemyBullet.BulletType.DECELERATE
		bullet.set_sprite("res://assets/sprites/bossbullut-4.png")
		get_parent().add_child(bullet)
		if i % 7 == 6:
			await get_tree().create_timer(0.03).timeout

	await get_tree().create_timer(0.10).timeout

	# Phase 3: HOMING bullets from all 4 screen edges converging on player
	for edge in range(4):
		for j in range(6):
			var spawn = Vector2.ZERO
			match edge:
				0: spawn = Vector2(randf_range(60.0, vp.x - 60.0), 12.0)
				1: spawn = Vector2(randf_range(60.0, vp.x - 60.0), vp.y - 12.0)
				2: spawn = Vector2(12.0, randf_range(60.0, vp.y - 60.0))
				3: spawn = Vector2(vp.x - 12.0, randf_range(60.0, vp.y - 60.0))
			var to_player = spawn.direction_to(player.global_position)
			var bullet = bullet_scene.instantiate() as EnemyBullet
			bullet.global_position = spawn
			bullet.direction = to_player
			bullet.speed = 210.0
			bullet.bullet_type = EnemyBullet.BulletType.HOMING
			bullet._homing_strength = 2.5
			bullet._homing_duration = 0.8
			bullet.set_sprite("res://assets/sprites/bossbullut-1.png")
			get_parent().add_child(bullet)
		await get_tree().create_timer(0.03).timeout

	await get_tree().create_timer(0.08).timeout

	# Phase 4: LASER spiral from boss - 6 arms, 50 steps
	for step in range(50):
		for arm in range(6):
			var angle = step * 0.14 + arm * (TAU / 6.0)
			var bullet = bullet_scene.instantiate() as EnemyBullet
			bullet.global_position = global_position
			bullet.direction = Vector2(cos(angle), sin(angle))
			bullet.speed = 200.0 + step * 0.8
			bullet.bullet_type = EnemyBullet.BulletType.LASER
			bullet.set_sprite("res://assets/sprites/bossbullut-11.png")
			get_parent().add_child(bullet)
		await get_tree().create_timer(0.02).timeout

	await get_tree().create_timer(0.06).timeout

	# Phase 5: Orbit cage around player that dashes inward
	var cage_center = player.global_position
	for i in range(20):
		var angle = (TAU / 20.0) * i
		var spawn_pos = cage_center + Vector2(cos(angle), sin(angle)) * 140.0
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = spawn_pos
		bullet.direction = Vector2.ZERO
		bullet.speed = 0.0
		bullet.set_sprite("res://assets/sprites/bossbullut-7.png")
		bullet.orbit_center = cage_center
		bullet.orbit_radius = 140.0
		bullet.orbit_angle = angle
		bullet.orbit_angular_speed = 4.0
		bullet.orbit_time_left = 1.2
		bullet.dash_after_orbit = true
		bullet.dash_target = cage_center
		bullet.dash_speed = 400.0
		get_parent().add_child(bullet)
		if i % 5 == 4:
			await get_tree().create_timer(0.02).timeout


func _boss2_love_transcendence() -> void:
	# Super: 3 SPLIT streams -> BOUNCE from corners -> CURVE walls -> ACCELERATE barrage
	if not bullet_scene or not get_parent():
		return
	var player = get_tree().get_first_node_in_group("player")
	if not player:
		return
	var vp = get_viewport_rect().size

	# Phase 1: 3 SPLIT streams aimed at player from boss, offset angles
	for stream in range(3):
		var base_aim = global_position.direction_to(player.global_position).angle()
		var stream_offset = (stream - 1) * 0.35
		for i in range(10):
			var wobble = sin(i * 0.8) * 0.12
			var angle = base_aim + stream_offset + wobble
			var bullet = bullet_scene.instantiate() as EnemyBullet
			bullet.global_position = global_position
			bullet.direction = Vector2(cos(angle), sin(angle))
			bullet.speed = 240.0 + i * 8.0
			bullet.bullet_type = EnemyBullet.BulletType.SPLIT
			bullet.set_sprite("res://assets/sprites/bossbullut-1.png")
			get_parent().add_child(bullet)
			await get_tree().create_timer(0.03).timeout

	await get_tree().create_timer(0.08).timeout

	# Phase 2: BOUNCE bullets from all 4 corners aimed at player
	var corner_positions = [
		Vector2(25.0, 25.0), Vector2(vp.x - 25.0, 25.0),
		Vector2(25.0, vp.y - 25.0), Vector2(vp.x - 25.0, vp.y - 25.0),
	]
	for rep in range(3):
		for corner in corner_positions:
			var to_player = (corner as Vector2).direction_to(player.global_position)
			for k in range(4):
				var spread = to_player.rotated((k - 1.5) * 0.15)
				var bullet = bullet_scene.instantiate() as EnemyBullet
				bullet.global_position = corner as Vector2
				bullet.direction = spread
				bullet.speed = 280.0
				bullet.bullet_type = EnemyBullet.BulletType.BOUNCE
				bullet.set_sprite("res://assets/sprites/bossbullut-10.png")
				get_parent().add_child(bullet)
		await get_tree().create_timer(0.06).timeout

	await get_tree().create_timer(0.08).timeout

	# Phase 3: CURVE walls closing in from left and right toward player
	var player_y = player.global_position.y
	for side in range(2):
		for i in range(16):
			var x_start = 15.0 if side == 0 else vp.x - 15.0
			var y_pos = clampf(player_y + (i - 7.5) * 28.0, 30.0, vp.y - 30.0)
			var spawn = Vector2(x_start, y_pos)
			var to_player = spawn.direction_to(player.global_position)
			var curve_dir = to_player.rotated(0.4 if side == 0 else -0.4)
			var bullet = bullet_scene.instantiate() as EnemyBullet
			bullet.global_position = spawn
			bullet.direction = curve_dir
			bullet.speed = 250.0
			bullet.bullet_type = EnemyBullet.BulletType.CURVE
			bullet.set_sprite("res://assets/sprites/bossbullut-14.png")
			get_parent().add_child(bullet)
		await get_tree().create_timer(0.04).timeout

	await get_tree().create_timer(0.06).timeout

	# Phase 4: Aimed ACCELERATE barrage - 24 bullets from boss at player
	var accel_aim = global_position.direction_to(player.global_position).angle()
	for i in range(24):
		var spread = accel_aim + (i - 11.5) * 0.07
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = global_position
		bullet.direction = Vector2(cos(spread), sin(spread))
		bullet.speed = 200.0
		bullet.bullet_type = EnemyBullet.BulletType.ACCELERATE
		bullet.set_sprite("res://assets/sprites/bossbullut-7.png")
		get_parent().add_child(bullet)
		if i % 4 == 3:
			await get_tree().create_timer(0.02).timeout


func _boss2_ultimate_heartbreak() -> void:
	# THE FINAL ATTACK: rain + spiral + HOMING + DECELERATE traps + LASER in rapid succession
	if not bullet_scene or not get_parent():
		return
	var player = get_tree().get_first_node_in_group("player")
	if not player:
		return
	var vp = get_viewport_rect().size

	# Phase 1: Rapid heart rain - 40 bullets from top aimed at player
	for i in range(40):
		var x_pos = randf_range(30.0, vp.x - 30.0)
		var rain_pos = Vector2(x_pos, 8.0)
		var to_player = rain_pos.direction_to(player.global_position)
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = rain_pos
		bullet.direction = to_player.rotated(randf_range(-0.1, 0.1))
		bullet.speed = randf_range(300.0, 400.0)
		bullet.set_sprite("res://assets/sprites/bossbullut-6.png")
		get_parent().add_child(bullet)
		if i % 5 == 4:
			await get_tree().create_timer(0.02).timeout

	await get_tree().create_timer(0.05).timeout

	# Phase 2: Double spiral from boss - 8 arms, 40 steps
	for step in range(40):
		for arm in range(8):
			var angle = step * 0.18 + arm * (TAU / 8.0)
			var bullet = bullet_scene.instantiate() as EnemyBullet
			bullet.global_position = global_position
			bullet.direction = Vector2(cos(angle), sin(angle))
			bullet.speed = 220.0 + step * 1.2
			bullet.set_sprite("res://assets/sprites/bossbullut-1.png")
			get_parent().add_child(bullet)
		await get_tree().create_timer(0.02).timeout

	await get_tree().create_timer(0.05).timeout

	# Phase 3: HOMING swarm from boss - 30 bullets fanning out then homing
	var fan_aim = global_position.direction_to(player.global_position).angle()
	for i in range(30):
		var angle = fan_aim + (i - 14.5) * 0.12
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = global_position
		bullet.direction = Vector2(cos(angle), sin(angle))
		bullet.speed = 200.0
		bullet.bullet_type = EnemyBullet.BulletType.HOMING
		bullet._homing_strength = 3.0
		bullet._homing_duration = 1.0
		bullet.set_sprite("res://assets/sprites/bossbullut-4.png")
		get_parent().add_child(bullet)
		if i % 5 == 4:
			await get_tree().create_timer(0.02).timeout

	await get_tree().create_timer(0.06).timeout

	# Phase 4: DECELERATE trap rings - 3 concentric rings around player
	for ring in range(3):
		var ring_center = player.global_position
		var ring_radius = 100.0 + ring * 70.0
		var ring_count = 16 + ring * 4
		for i in range(ring_count):
			var angle = (TAU / float(ring_count)) * i
			var spawn = ring_center + Vector2(cos(angle), sin(angle)) * ring_radius
			var inward = spawn.direction_to(ring_center)
			var bullet = bullet_scene.instantiate() as EnemyBullet
			bullet.global_position = spawn
			bullet.direction = inward
			bullet.speed = 180.0 + ring * 30.0
			bullet.bullet_type = EnemyBullet.BulletType.DECELERATE
			bullet.set_sprite("res://assets/sprites/bossbullut-10.png")
			get_parent().add_child(bullet)
		await get_tree().create_timer(0.04).timeout

	await get_tree().create_timer(0.05).timeout

	# Phase 5: LASER cross beams from boss aimed at player + orbit finisher
	var laser_aim = global_position.direction_to(player.global_position).angle()
	for beam in range(4):
		var beam_angle = laser_aim + beam * (PI / 2.0)
		for i in range(12):
			var bullet = bullet_scene.instantiate() as EnemyBullet
			bullet.global_position = global_position
			bullet.direction = Vector2(cos(beam_angle), sin(beam_angle))
			bullet.speed = 250.0 + i * 12.0
			bullet.bullet_type = EnemyBullet.BulletType.LASER
			bullet.set_sprite("res://assets/sprites/bossbullut-11.png")
			get_parent().add_child(bullet)
		await get_tree().create_timer(0.03).timeout

	await get_tree().create_timer(0.04).timeout

	# Final orbit cage collapse
	var final_center = player.global_position
	for i in range(24):
		var angle = (TAU / 24.0) * i
		var spawn_pos = final_center + Vector2(cos(angle), sin(angle)) * 160.0
		var bullet = bullet_scene.instantiate() as EnemyBullet
		bullet.global_position = spawn_pos
		bullet.direction = Vector2.ZERO
		bullet.speed = 0.0
		bullet.set_sprite("res://assets/sprites/bossbullut-14.png")
		bullet.orbit_center = final_center
		bullet.orbit_radius = 160.0
		bullet.orbit_angle = angle
		bullet.orbit_angular_speed = 5.0
		bullet.orbit_time_left = 0.9
		bullet.dash_after_orbit = true
		bullet.dash_target = final_center
		bullet.dash_speed = 400.0
		get_parent().add_child(bullet)
		if i % 6 == 5:
			await get_tree().create_timer(0.02).timeout